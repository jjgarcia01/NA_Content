namespace: Digital_twin.subflows
operation:
  name: create_node_py
  inputs:
    - username: "${get_sp('eve_admin_user_NG')}"
    - password: "${get_sp('eve_admin_password_NG')}"
    - eveng_network_ip: "${get_sp('eveng_network_ip_NG')}"
    - labPath
    - deviceName
    - image
    - ipAddress
  python_action:
    use_jython: false
    script: "def execute(username,password,eveng_network_ip,labPath,deviceName,image,ipAddress):\n\n    from evengsdk.client import EvengClient\n    import logging\n    import os\n\n    def upload_config(path,config,name):\n        resp = client.api.get_node_by_name(path,name=name)\n        nodeID=resp['id']\n        logger.info(\"Node ID =\"+str(nodeID))\n        client.api.upload_node_config(path, node_id=nodeID, config=config)\n        client.api.enable_node_config(labPath, node_id=nodeID)\n        logger.info(\"upload config_done\")\n    # end of function upload_config\n    \n    def get_node_config(device,ipAddress,template):\n\n        f = open(\"/opt/eveng/configs/\"+template, \"r\")\n        config = f.read()\n        f.close()\n        config = config.replace(\"deviceName\",device) # replace hostname\n        config = config.replace(\"ipAddress\",ipAddress) # replace ipAddress\n                \n        return config\n        \n    # end of function get_node_config\n\n\n############################################################################\n# Start of main\n############################################################################\n    vendorList = []\n    ipList = []  \n\n# Start the logging\n    logger = logging.getLogger(__name__)\n    logging.basicConfig(filename='/tmp/eve.log', level=logging.INFO)\n\n# Login to eveng\n    client = EvengClient(eveng_network_ip, log_file=\"test.log\", ssl_verify=False, protocol=\"https\")\n    client.disable_insecure_warnings()  # disable warnings for self-signed certificates\n    client.login(username=username, password=password)\n    client.set_log_level(\"DEBUG\")\n\n    # setup some variables for the connections\n    left=0 # this is the starting point for drawing the nodes\n\n    # template takes everything to the left of the '-' character in the image_name field\n    template = image.split('-')[0].strip()\n        \n     # Add the node\n    unique = \"{0:0{1}x}\".format(int(ipAddress.split('.')[3]),2)\n    firstmac = '50:02:'+unique+':02:00:00'\n\n    resp = client.api.add_node(labPath, name=deviceName,template=template,image=image,config=\"Saved\",firstmac = firstmac,left=left,top=200)\n    if resp['status'] == \"success\":\n            logger.info(str(resp))\n            logger.info('create client, image = '+image.split('-')[0])   \n            \n      # Connect the node\n    logger.info(\"about to connect the node with template \"+template)\n    match template:\n        case 'veos':\n            resp = client.api.connect_node_to_cloud(labPath,src=deviceName,src_label=\"Mgmt1\",dst=\"eve-mgmt\")\n        case 'nxosv9k':\n            resp = client.api.connect_node_to_cloud(labPath,src=deviceName,src_label=\"Mgmt0\",dst=\"eve-mgmt\")\n        case 'mikrotik':\n            logger.info(\"Got a mikrotik\")\n            vendorList.append(template)\n            resp = client.api.connect_node_to_cloud(labPath,src=deviceName,src_label=\"eth1\",dst=\"eve-mgmt\")\n        case 'vios':\n            logger.info(\"Got a vios\")\n            resp = client.api.connect_node_to_cloud(labPath,src=deviceName,src_label=\"Gi0/0\",dst=\"eve-mgmt\")\n            vendorList.append(template)\n        case _:\n            logger.error('Unknown device type')\n            \n    if resp['status'] == \"success\":\n        logger.info('connect client to mgmt network')        \n    left+=200\n\n    ipList.append(ipAddress) \n \n        # Get and customise the config file and then upload the customized file\n        # and enable the configs before we start the lab.\n    config = get_node_config(device=deviceName,ipAddress=ipAddress,template=template)\n    upload_config(path=labPath,config=config,name=deviceName)\n       \n    client.logout()\n   \n    a = zip(ipList,vendorList)\n    deviceList = str(list(a)).replace(\"[\",\"\").replace(\"]\",\"\").replace(\"),\",\"|\").replace(\"(\",\"\").replace(\")\",\"\")\n    return { \"deviceList\" : deviceList }"
  results:
    - SUCCESS
